# PicSubToAnki 使用说明文档

## 一、软件简介
PicSubToAnki 是一款用于将图片中的字幕/单词信息快速转换为 Anki 记忆卡片的工具，支持日语（默认）和英语两种语言模式。通过集成 OpenAI 大模型自动解析单词信息，并结合 AnkiConnect 实现卡片自动导入，帮助语言学习者高效构建个性化词库。

## 二、功能特性
- **多语言支持**：支持日语（"jp"）和英语（"en"）模式切换
- **图片批量处理**：可选择包含多张图片的文件夹，支持单张/批量创建卡片
- **智能解析**：自动识别单词原型、发音、释义，并结合例句生成记忆笔记
- **媒体集成**：自动压缩图片并关联至 Anki 卡片，支持单词发音音频（日语使用 LanguagePod101，英语使用有道词典）
- **便捷操作**：提供全选/取消全选、批量添加等快捷功能

## 三、环境要求
1. **Anki 环境**：
   - 安装 Anki 2.1+（推荐最新版）
   - 安装 [AnkiConnect](https://ankiweb.net/shared/info/2055492159) 插件（需启动插件服务，默认端口 8765）
2. **Python 环境**：
   - Python 3.8+
   - 依赖库：`tkinter`, `Pillow`, `requests`, `openai`, `python-dotenv`（可通过 `pip install -r requirements.txt` 安装）
3. **配置文件**（新增）：
   - 在项目根目录创建 `config.ini` 文件，内容示例：
     ```ini
     [openai]
     api_key = 你的API密钥  # 如 sk-xxxx 或阿里云通义千问密钥
     base_url = https://dashscope.aliyuncs.com/compatible-mode/v1  # 模型服务地址
     model_name = qwen-plus  # 模型名称（根据服务调整）

     [anki]
     jp_deck = 日本語::ランダム::アニメ・マンガ・マスコミ  # 日语卡组名称
     en_deck = English Vocabulary::A English Daily  # 英语卡组名称
     model_name = 划词助手Antimoon模板  # Anki 卡片模板名称
     word_field = 单词  # 单词字段名
     pronunciation_field = 音标  # 音标字段名
     meaning_field = 释义  # 释义字段名
     note_field = 笔记  # 笔记字段名
     example_field = 例句  # 例句字段名
     voice_field = 发音  # 发音字段名
     max_width = 320 # 压缩后图片的最大宽度（像素）
     max_height = 240 # 压缩后图片的最大高度（像素）
     image_quality = 60 # 压缩后图片的质量（0-100）

     ```
   - 需要有效的 OpenAI API 密钥（或兼容的大模型服务，如示例中的阿里云通义千问）

## 四、界面说明
![主界面示意图](show.jpg)

（注：实际界面以运行时为准）

| 区域       | 功能说明                                                                 |
|------------|--------------------------------------------------------------------------|
| 顶部工具栏 | 包含「选择文件夹」（选择图片目录）、「批量添加」（批量创建选中卡片）、「全选」/「取消全选」（快速勾选/取消图片）、「切换模式」（日语/英语模式切换）按钮 |
| 内容区域   | 显示图片缩略图、文件名、单词输入框及创建卡片按钮（首列新增确认框用于批量选择），支持滚动查看多文件 |
| 模式标签   | 显示当前语言模式（日语/英语）                                             |

## 五、使用流程
### 步骤 0：安装依赖
在项目根目录（与 `requirements.txt` 同级）中，通过命令行执行以下命令安装所需依赖：
```bash
pip install -r requirements.txt
```
### 步骤 1：启动程序
双击项目根目录下的 `start.cmd` 文件，即可启动工具。该脚本会自动执行 `python main.py` 完成程序初始化。

### 步骤 2：配置参数
在项目根目录的 `config.ini` 文件中填写以下内容（无需修改代码）：
- `[openai]` 部分：填写大模型 API 密钥、服务地址和模型名称
- `[anki]` 部分：配置 Anki 卡组名称、卡片模板及各字段对应关系

### 步骤 3：处理图片文件
1. 点击「选择文件夹」按钮，选择包含目标图片的文件夹（支持 .png, .jpg, .jpeg, .gif, .bmp 格式）
2. 内容区域将显示所有图片的缩略图、文件名、单词输入框及首列确认框（用于批量选择）
3. 在「单词」输入框中填写需要解析的目标词汇（需存在于图片内容中）

### 步骤 4：创建 Anki 卡片
- **导入模板**：如果你没有合适的模板，可以选择目录下的Default.apkg导入。这个模板在正面会将所有的加粗字体显示为省略号。
- **单张创建**：点击对应图片的「创建卡片」按钮，系统将自动：
  1. 调用大模型解析单词信息（原型、发音、释义等）
  2. 压缩图片并上传至 Anki 媒体库
  3. 生成包含图片、发音、例句的 Anki 卡片
- **批量创建**：
  1. 通过「全选」按钮勾选所有图片，或手动勾选需要处理的图片（首列确认框）
  2. 点击「批量添加」按钮，系统将批量执行单张创建流程

### 步骤 5：切换语言模式
点击「切换模式」按钮可在日语/英语模式间切换，模式标签会同步更新状态。切换后：
- 日语模式：使用日语词典解析规则，卡片存入 `config.ini` 中配置的 `jp_deck` 牌组
- 英语模式：使用英语词典解析规则，卡片存入 `config.ini` 中配置的 `en_deck` 牌组

## 六、注意事项
1. **API 调用限制**：频繁调用可能触发 OpenAI 速率限制，建议合理控制批量处理数量
2. **图片压缩**：图片将被压缩为最大 320x240 像素的 JPG 格式（质量 60），不影响 Anki 显示
3. **输入验证**：单词输入框不能为空，否则会提示错误
4. **服务连通性**：若 AnkiConnect 未启动或端口被占用，创建卡片时会提示连接错误

## 七、常见问题
- **Q：创建卡片后无反应？**  
  A：检查 AnkiConnect 服务是否运行（可通过 `http://localhost:8765` 测试连通性）；查看终端输出是否有 API 调用错误信息。
- **Q：图片无法加载？**  
  A：确认图片格式支持（仅列出格式）；检查图片是否被其他程序占用；尝试重启工具。
- **Q：发音链接无效？**  
  A：日语发音依赖 LanguagePod101 服务（可能因地区限制不可用）；英语发音依赖有道词典，部分生僻词可能无音频。

## 七、prompt参考
- **日语prompt**：
```
1. 日文单词原型（如果是变形，返回原形）
2. 日文的发音
3. 单词在词典中的日文释义（不包含单词本身，必须只有日文）
4. 当前的例句，并将和单词的部分用<b>{key}</b>的形式包围
5. 用中文结合语境解释一下当前单词的意思
```
- **英文prompt**：
```
1. 英文单词原型（如果是变形，返回原形）
2. 单词的音标
3. 单词在词典中的英文释义（不包含单词本身，必须只有英文）
4. 当前的例句，并将和单词的部分用<b>{key}</b>的形式包围
5. 用中文结合语境解释一下当前单词的意思
```
如果有需要，请参考如上prompt自行修改

---
> 文档版本：v1.3  
> 更新日期：2025-05-25

        